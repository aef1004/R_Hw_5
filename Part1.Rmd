---
title: "Hw_5"
author: "Amy Fox Randy Xun Ana Velasquez"
date: "November 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load necessary packages
```{r}
library(readr)
library(dplyr)
library(sf)
library(tigris)
library(ggplot2)
library(forcats)
```

#Part 3#

Pick one city in the data. Create a map showing the locations of the homicides in that city, using the sf framework discussed in class. Use tigris to download boundaries for some sub-city geography (e.g., tracts, block groups, county subdivisions) to show as a layer underneath the points showing homicides. Use different facets for solved versus unsolved homicides and different colors to show the three race groups with the highest number of homicides for that city (you may find the fct_lump function from forcats useful for this).

```{r}
homicides <- read_csv("./data/homicide-data.csv")
homicides3 <- homicides
head(homicides)
```

Need to filter out lat and lon NA to work on geom_sf

Alternative for fct_lump

homicides %>%
  group_by(victim_race) %>%
  summarise(total = n()) %>%
  arrange(desc(total))

Houston_homicides <- homicides %>%
  filter(victim_race == "Black"| victim_race ==  "Hispanic" | victim_race == "White") 
```{r}
homicides <- homicides %>%
  filter(city == "Houston") %>%
  select(victim_race, lat, lon, disposition) %>%
  mutate(unsolved = disposition != "Closed by arrest") %>%
  filter(!is.na(lon), !is.na(lat))

Houston_homicides <- homicides %>%  
  mutate(victim_race_factor = fct_lump(as.factor(victim_race), n = 3))


```

Pull counties, plot the locations of homicides over it 

```{r}

#is this st_set_Crs correct? How do you find it?
homicides_sf <- st_as_sf(Houston_homicides,
                         coords = c("lon", "lat")) %>%
  st_set_crs(4326)

TX_tracts <- tracts("Texas", county = "Harris County", cb = TRUE) 

TX_tracts <- st_as_sf(TX_tracts)

facet_names <- c("TRUE" = "Unsolved Homicides",
                 "FALSE" = "Solved Homicides")

ggplot(homicides_sf) +
  facet_wrap(~unsolved, nrow = 2, 
             labeller = as_labeller(facet_names)) +
  geom_sf(data = TX_tracts) +
  geom_sf(data = homicides_sf, aes(color = victim_race_factor), size = 0.1) +
  ggtitle("Homicides in Houston, TX")

```



#Part 4

Recreate the graph shown below. It shows monthly homicides in Baltimore, with a reference added for the date of the arrest of Freddie Gray and color used to show colder months (November through April) versus warmer months (May through October). There is a smooth line added to help show seasonal and long-term trends in this data

#Part 5

Create one more plot using this data. Work with your group to create a plot that follows the principles of good plotting and that you think illustrates something interesting in the data. Write a paragraph explaining what the plot is showing and why you find it interesting.

```{r q5_cleanup}
library(tidyr)
library(lubridate)
library(broom)
library(purrr)

homicides3 <- homicides3 %>% 
  unite(col = city_name, city, state, sep = ", ") %>% 
  mutate(reported_date = ymd(reported_date)) %>% 
  arrange(reported_date)

homi2017 <- filter(homicides3, reported_date >= ymd(20170101) & 
                     reported_date <= ymd(20171231))

homi2007 <- filter(homicides3, reported_date >= ymd(20070101) & 
                     reported_date <= ymd(20071231))

unsolved2017 <- homi2017 %>% 
  select(city_name, disposition) %>% 
  group_by(city_name) %>% 
  mutate(unsolved = disposition != 'Closed by arrest') %>% 
  summarize(total_homicides17 = n(),
            total_unsolved17 = sum(unsolved))

unsolved2007 <- homi2007 %>% 
  select(city_name, disposition) %>% 
  group_by(city_name) %>% 
  mutate(unsolved = disposition != 'Closed by arrest') %>% 
  summarize(total_homicides07 = n(),
            total_unsolved07 = sum(unsolved))

combo_unsolved <- inner_join(unsolved2017, unsolved2007)


proportion_unsolved2017 <- unsolved2017 %>% 
  mutate(test = map2(total_unsolved17, total_homicides17,
                     ~ prop.test(.x, n = .y))) %>% 
  mutate(test = map(test,
                    ~ tidy(.x))) %>% 
  unnest(.drop = TRUE) %>% 
  select(city_name, estimate)

proportion_unsolved2007 <- unsolved2007 %>% 
  mutate(test = map2(total_unsolved07, total_homicides07,
                     ~ prop.test(.x, n = .y))) %>% 
  mutate(test = map(test,
                    ~ tidy(.x))) %>% 
  unnest(.drop = TRUE) %>% 
  select(city_name, estimate)

combo_proportion <- inner_join(proportion_unsolved2017, proportion_unsolved2007,
                               by = "city_name")
diff_proportion <- combo_proportion %>% 
  mutate(diff_percent = (estimate.x - estimate.y))   
```

```{r custom_graph}
diff_proportion %>% 
  mutate(city_name = fct_reorder(city_name, diff_percent)) %>% 
  ggplot(aes(x = diff_percent, y = city_name)) +
  geom_point(color= "white") +
  theme_dark() 
```
For this part of the assignment, our group looked at how the percentage of unsolved murders in the major cities changed from the first year of the study (2007) to the last year of the study (2017). This finding is interesting because it could potentially show which police forces are getting better at solving murders. At the same time, this graph can help identify cities which are declining over time.